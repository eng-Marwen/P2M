name: CI/CD Backend

on:
  push:
    paths:
      - "backend/**"
      - ".github/workflows/backend.yaml"
    branches: [main]
  pull_request:
    paths:
      - "backend/**"
      - ".github/workflows/backend.yaml"
    branches: [main]

env:
  SERVICE_NAME: backend
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/samsar

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          
      - name: Install dependencies
        run: |
          cd backend
          npm install
          
      - name: Run tests
        run: |
          cd backend
          npm test
          # 5. Run SonarCloud analysis
          
  sonarqube:
    needs: test
    name: SonarQube
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  version:
    needs: sonarqube
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/version-and-tag.yml
    with:
      service_name: backend
    secrets: inherit

  build-and-push:
    needs: version
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push backend image to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/samsar:backend-${{ needs.version.outputs.version }}

      ###!!!!!!!!!!!!!only when feat fix BREAKING CHANGE
      # - name: Deploy to Render
      #   run: |
      #     curl -X POST https://api.render.com/deploy/srv-d5j7lp0gjchc73d0060g \
      #     -H "Accept: application/json" \
      #     -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"

# Push to main
#    ↓
# Checkout code
#    ↓
# Install dependencies
#    ↓
# Run Jest tests
#    ↓
# Tests pass?
#    ├── NO → Stop
#    └── YES
#          ↓
#      Build Docker image
#          ↓
#      Push image to Docker Hub
#          ↓
#      Deploy on render
#

# B. Continuous Integration (CI) — Testing & Validation

# Ensure the code works and is high quality before deployment.

# Common steps:

# Checkout code (clone the repo)

# Set up environment (Node.js, Python, Java, etc.)

# Install dependencies

# Run tests (unit, integration, end-to-end)

# Optional:

# Linting / code formatting check

# Static type checks (TypeScript)

# Security audit (npm audit)

# Test coverage check

# ✅ Goal: catch issues early.

# C. Continuous Delivery / Deployment (CD) — Build & Deploy

# Get the code live automatically if CI passes.

# Common steps:

# Build artifacts (Docker image, binary, zip, etc.)

# Tag version (semantic version + commit SHA)

# Push artifact (Docker registry, package manager)

# Deploy to target environment:

# Cloud service (Render, Railway, Fly.io)

# Kubernetes cluster

# Serverless platform
