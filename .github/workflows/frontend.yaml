name: CI/CD Frontend
#event listners to triggers jobs
on:
  push:
    paths:
      - "frontend/**"
      - ".github/workflows/frontend.yaml"

    branches: [main]
  pull_request:
    paths:
      - "frontend/**"
      - ".github/workflows/frontend.yaml"
    branches: [main]
#actions
jobs:
  #job name
  BuilCode:
    #GitHub gives you a temporary VM comes with the most used tools :docker ,node git ... the vm is destroyd after the job end
    runs-on: ubuntu-latest
    #steps run sequentially one step fail --> job stop
    steps:
      #Clones your GitHub repository into the VM its like git clone your-repo
      - name: checkout repo
        uses: actions/checkout@v4 #existen
      #Installs Node.js v18 in the VM
      - name: setup node js
        uses: actions/setup-node@v4
        with:
          node-version: 18

  version:
    needs: BuilCode
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/version-and-tag.yml
    with:
      service_name: frontend
    secrets: inherit

  BuildAndPushDockerImage:
    runs-on: ubuntu-latest
    needs: version
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      # ⚠️ CRITICAL: Checkout the code first!
      - name: checkout repo
        uses: actions/checkout@v4

      #prepare docker for building images
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      #Authenticates GitHub VM with Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
     
      #Build & push frontend Docker image
      - name: build and push frontend image to docker hub
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/samsar:frontend-${{ needs.version.outputs.version }}       
      ###!!!!!!!!!!!!!only when feat fix BREAKING CHANGE
      # - name: Deploy to Render
      #   run: |
      #     curl -X POST https://api.render.com/deploy/srv-d5j7lp0gjchc73d0060g \
      #     -H "Accept: application/json" \
      #     -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"

# Push to main
#    ↓
# Checkout code
#    ↓
# Install dependencies
#    ↓
# Run Jest tests
#    ↓
# Tests pass?
#    ├── NO → Stop
#    └── YES
#          ↓
#      Build Docker image
#          ↓
#      Push image to Docker Hub
#          ↓
#      Deploy on render
#

# B. Continuous Integration (CI) — Testing & Validation

# Ensure the code works and is high quality before deployment.

# Common steps:

# Checkout code (clone the repo)

# Set up environment (Node.js, Python, Java, etc.)

# Install dependencies

# Run tests (unit, integration, end-to-end)

# Optional:

# Linting / code formatting check

# Static type checks (TypeScript)

# Security audit (npm audit)

# Test coverage check

# ✅ Goal: catch issues early.

# C. Continuous Delivery / Deployment (CD) — Build & Deploy

# Get the code live automatically if CI passes.

# Common steps:

# Build artifacts (Docker image, binary, zip, etc.)

# Tag version (semantic version + commit SHA)

# Push artifact (Docker registry, package manager)

# Deploy to target environment:

# Cloud service (Render, Railway, Fly.io)

# Kubernetes cluster

# Serverless platform
